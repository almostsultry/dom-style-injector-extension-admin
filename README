# D365 DOM Style Injector Extension

A unified Chrome/Edge extension for CSS customization in Dynamics 365, with role-based access control through Dataverse security roles.

## ğŸš€ Key Features

- **Unified Extension**: Single codebase with dynamic UI based on user roles
- **Role-Based Access**: Admin features for users with System Customizer role
- **CSS Injection**: Apply custom styles to D365 pages
- **SharePoint Sync**: Centralized storage for organization-wide customizations
- **Secure Authentication**: Microsoft identity integration

## ğŸ“ Project Structure (Refactored)

```
dom-style-injector-extension/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ popup/
â”‚   â”‚   â”œâ”€â”€ popup.js         # Main popup logic with auth
â”‚   â”‚   â””â”€â”€ popup.css        # Styles for popup
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”œâ”€â”€ service-worker.js # Background service worker
â”‚   â”‚   â””â”€â”€ content.js       # CSS injection script
â”‚   â”œâ”€â”€ options/
â”‚   â”‚   â”œâ”€â”€ options.html     # Extension settings
â”‚   â”‚   â””â”€â”€ options.js       # Settings logic
â”‚   â””â”€â”€ manifest.json        # Extension manifest
â”œâ”€â”€ assets/                  # Icons and images
â”œâ”€â”€ build/                   # Build configuration
â”‚   â””â”€â”€ webpack.config.js    # Webpack configuration
â”œâ”€â”€ dist/                    # Build output (gitignored)
â”œâ”€â”€ docs/                    # Documentation
â””â”€â”€ package.json            # Dependencies and scripts
```

## ğŸ”§ Installation & Setup

### Prerequisites
- Node.js >= 16.0.0
- Microsoft 365 account with D365 access
- Azure AD app registration (for authentication)

### Development Setup

1. **Clone the repository**
   ```bash
   git clone https://github.com/almostsultry/dom-style-injector-extension-admin.git
   cd dom-style-injector-extension-admin
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Configure environment**
   - Copy `config/development.example.json` to `config/development.json`
   - Update with your Azure AD and D365 settings:
     ```json
     {
       "azureAd": {
         "clientId": "YOUR_CLIENT_ID",
         "tenantId": "YOUR_TENANT_ID"
       },
       "dynamics365": {
         "orgUrl": "https://yourorg.crm.dynamics.com"
       }
     }
     ```

4. **Build the extension**
   ```bash
   npm run build
   ```

5. **Load in browser**
   - Open Chrome/Edge extensions page
   - Enable Developer mode
   - Click "Load unpacked"
   - Select the `dist` folder

## ğŸ¯ Usage

### First Time Setup
1. Click the extension icon
2. Sign in with your Microsoft account
3. Extension will detect your role automatically

### For Administrators (System Customizer Role)
- **Create Customizations**: Define CSS rules for D365 elements
- **Manage Rules**: Edit, delete, and toggle customizations
- **Sync to SharePoint**: Publish customizations for all users
- **Test Changes**: Preview before publishing

### For Standard Users
- **View Customizations**: See available style modifications
- **Toggle On/Off**: Enable/disable specific customizations
- **Sync Updates**: Get latest customizations from SharePoint

## ğŸ” Security & Permissions

### Required Permissions
- `identity`: For Microsoft authentication
- `storage`: For saving customizations locally
- `https://*.dynamics.com/`: To inject styles into D365

### Role-Based Access
- **System Customizer**: Full CRUD operations
- **Standard Users**: Read-only access with toggle capability

### Data Storage
- **Local Storage**: User preferences and cache
- **SharePoint**: Centralized customization repository
- **No sensitive data**: Only CSS rules and metadata

## ğŸ› ï¸ Development

### Available Scripts
```bash
npm run dev          # Start development mode
npm run build        # Build for production
npm run test         # Run tests
npm run lint         # Lint code
npm run format       # Format code
```

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Popup UI      â”‚â”€â”€â”€â”€â–¶â”‚ Service Worker   â”‚â”€â”€â”€â”€â–¶â”‚   Dataverse     â”‚
â”‚  (Role-based)   â”‚     â”‚  (Background)    â”‚     â”‚   (API calls)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                         â”‚
         â–¼                       â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Content Script  â”‚     â”‚ Authentication   â”‚     â”‚  SharePoint     â”‚
â”‚ (CSS Injection) â”‚     â”‚    (MSAL)        â”‚     â”‚   (Storage)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Components

1. **Popup (popup.js)**
   - Handles authentication flow
   - Determines user role
   - Renders appropriate UI

2. **Service Worker (service-worker.js)**
   - Manages background tasks
   - Handles API communication
   - Caches user roles

3. **Content Script (content.js)**
   - Injects CSS into D365 pages
   - Watches for DOM changes
   - Handles dynamic navigation

## ğŸ§ª Testing

### Manual Testing
1. Load extension in developer mode
2. Test role detection with different accounts
3. Verify CSS injection on D365 pages
4. Test sync functionality

### Automated Tests
```bash
npm test                 # Run all tests
npm run test:unit       # Unit tests only
npm run test:e2e        # E2E tests with Playwright
```

## ğŸ“ Configuration

### Options Page
Access via extension icon â†’ Settings, or right-click â†’ Options

Configurable settings:
- D365 Organization URL
- Sync frequency
- Cache duration
- Debug mode

### Environment Variables
For development, create `.env` file:
```env
D365_ORG_URL=https://yourorg.crm.dynamics.com
AZURE_CLIENT_ID=your-client-id
AZURE_TENANT_ID=your-tenant-id
```

## ğŸš€ Deployment

### Building for Production
```bash
npm run build:prod
```

### Chrome Web Store
1. Create ZIP of `dist` folder
2. Upload to Chrome Developer Dashboard
3. Fill in store listing details
4. Submit for review

### Microsoft Edge Add-ons
1. Same package as Chrome
2. Upload to Partner Center
3. Complete certification process

## ğŸ¤ Contributing

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

### Coding Standards
- ESLint configuration enforced
- Prettier for formatting
- Conventional commits
- 80% test coverage minimum

## ğŸ“„ License

MIT License - see [LICENSE](LICENSE) file

## ğŸ†˜ Support

- **Issues**: [GitHub Issues](https://github.com/almostsultry/dom-style-injector-extension-admin/issues)
- **Discussions**: [GitHub Discussions](https://github.com/almostsultry/dom-style-injector-extension-admin/discussions)
- **Email**: support@example.com

## ğŸ”„ Changelog

### Version 2.0.0 (Current)
- Unified extension architecture
- Role-based access control
- Improved authentication flow
- SharePoint integration placeholder

### Version 1.0.0
- Initial release
- Separate admin/user versions
- Basic CSS injection

---

**Note**: This extension requires proper Azure AD configuration and D365 permissions. Contact your IT administrator for setup assistance.html      # Unified popup with role-based views
â”‚   â”‚   â”œâ”€â”€ popup.