<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D365 DOM Style Injector</title>
    <link href="../styles/common.css" rel="stylesheet">
    <link href="popup.css" rel="stylesheet">
    <link href="../styles/pseudo-classes.css" rel="stylesheet">
</head>

<body>
    <!-- PRESERVED: Existing loader view -->
    <div id="loader-view" class="view">
        <div class="header">
            <h1>Style Injector</h1>
            <div class="subtitle">Loading...</div>
        </div>
        <div class="content">
            <div class="section text-center">
                <p>Authenticating and checking permissions...</p>
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- ENHANCED: Admin view with preserved functionality + new features -->
    <div id="admin-view" class="view">
        <div class="header">
            <h1>Style Administrator</h1>
            <div class="subtitle">Create and manage injection rules</div>
        </div>

        <div class="content">
            <!-- PRESERVED: Quick CSS Editor (existing functionality) -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Quick CSS Editor</h2>
                    <button id="toggle-quick-editor" class="btn btn-secondary btn-sm">
                        <span class="btn-text">Toggle</span>
                    </button>
                </div>

                <div id="quick-editor-section" class="quick-editor">
                    <div class="form-group">
                        <label for="css-editor" class="form-label">CSS Rules</label>
                        <textarea id="css-editor" class="form-textarea" rows="6" placeholder="Enter custom CSS...
Example:
.btn-primary {
  background-color: #007acc;
  color: white;
}"></textarea>
                    </div>

                    <div class="form-actions">
                        <button id="save-rule" class="btn btn-primary">Save Rule</button>
                        <button id="clear-editor" class="btn btn-secondary">Clear</button>
                    </div>
                </div>
            </div>

            <!-- NEW: Advanced Rule Creator with Pseudo-Class Support -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Advanced Rule Creator</h2>
                    <button id="toggle-create-form" class="btn btn-primary">
                        <span class="btn-text">New Rule</span>
                        <span class="btn-icon">+</span>
                    </button>
                </div>

                <div id="create-form" class="create-form">
                    <form id="customization-form">
                        <div class="form-group">
                            <label for="rule-name" class="form-label">Rule Name</label>
                            <input type="text" id="rule-name" class="form-input" placeholder="e.g., Button Hover Effect"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="css-selector" class="form-label">CSS Selector</label>
                            <input type="text" id="css-selector" class="form-input"
                                placeholder="e.g., .btn-primary, #save-button" required
                                aria-describedby="selector-help">
                            <small id="selector-help" class="form-help">Target elements using CSS selectors (e.g.,
                                .class-name, #element-id, [data-attribute])</small>
                        </div>

                        <div class="form-group">
                            <label for="base-css" class="form-label">Base CSS Properties</label>
                            <textarea id="base-css" class="form-textarea" rows="4" placeholder="background-color: #007acc;
color: white;
border-radius: 4px;" aria-describedby="base-css-help"></textarea>
                            <small id="base-css-help" class="form-help">CSS properties applied to all matching elements
                                in their default state</small>
                        </div>

                        <!-- NEW: Pseudo-Class Configuration -->
                        <div class="form-group">
                            <label class="form-label">
                                Element States & Pseudo-Classes
                                <small class="form-help">Define styles for different element states</small>
                            </label>
                            <div class="pseudo-class-container">
                                <div class="pseudo-class-tabs">
                                    <button type="button" class="pseudo-tab active" data-pseudo="hover">:hover</button>
                                    <button type="button" class="pseudo-tab" data-pseudo="active">:active</button>
                                    <button type="button" class="pseudo-tab" data-pseudo="focus">:focus</button>
                                    <button type="button" class="pseudo-tab"
                                        data-pseudo="focus-within">:focus-within</button>
                                    <button type="button" class="pseudo-tab" data-pseudo="valid">:valid</button>
                                    <button type="button" class="pseudo-tab" data-pseudo="invalid">:invalid</button>
                                    <button type="button" class="pseudo-tab" data-pseudo="disabled">:disabled</button>
                                    <button type="button" class="pseudo-tab" data-pseudo="checked">:checked</button>
                                </div>

                                <div class="pseudo-class-content">
                                    <div class="pseudo-panel active" data-pseudo="hover">
                                        <div class="form-group">
                                            <label for="hover-css" class="form-label">Hover State CSS</label>
                                            <textarea id="hover-css" class="form-textarea pseudo-css" rows="3"
                                                placeholder="background-color: #0056b3;
transform: scale(1.05);
transition: all 0.3s ease;" aria-describedby="hover-help"></textarea>
                                            <small id="hover-help" class="form-help">CSS applied when user hovers over
                                                the element</small>
                                            <div class="pseudo-class-toggle">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" class="pseudo-enabled" data-pseudo="hover"
                                                        aria-label="Enable hover styles">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="toggle-label">Enable :hover styles</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pseudo-panel" data-pseudo="active">
                                        <div class="form-group">
                                            <label for="active-css" class="form-label">Active State CSS</label>
                                            <textarea id="active-css" class="form-textarea pseudo-css" rows="3"
                                                placeholder="background-color: #004494;
transform: scale(0.95);
transition: all 0.1s ease;" aria-describedby="active-help"></textarea>
                                            <small id="active-help" class="form-help">CSS applied when element is being
                                                clicked or pressed</small>
                                            <div class="pseudo-class-toggle">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" class="pseudo-enabled" data-pseudo="active"
                                                        aria-label="Enable active styles">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="toggle-label">Enable :active styles</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pseudo-panel" data-pseudo="focus">
                                        <div class="form-group">
                                            <label for="focus-css" class="form-label">Focus State CSS</label>
                                            <textarea id="focus-css" class="form-textarea pseudo-css" rows="3"
                                                placeholder="outline: 2px solid #007acc;
outline-offset: 2px;
box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.3);" aria-describedby="focus-help"></textarea>
                                            <small id="focus-help" class="form-help">CSS applied when element receives
                                                keyboard focus</small>
                                            <div class="pseudo-class-toggle">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" class="pseudo-enabled" data-pseudo="focus"
                                                        aria-label="Enable focus styles">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="toggle-label">Enable :focus styles</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pseudo-panel" data-pseudo="focus-within">
                                        <div class="form-group">
                                            <label for="focus-within-css" class="form-label">Focus-Within State
                                                CSS</label>
                                            <textarea id="focus-within-css" class="form-textarea pseudo-css" rows="3"
                                                placeholder="border-color: #007acc;
box-shadow: 0 0 0 1px rgba(0, 122, 204, 0.2);" aria-describedby="focus-within-help"></textarea>
                                            <small id="focus-within-help" class="form-help">CSS applied when element or
                                                its children have focus</small>
                                            <div class="pseudo-class-toggle">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" class="pseudo-enabled"
                                                        data-pseudo="focus-within"
                                                        aria-label="Enable focus-within styles">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="toggle-label">Enable :focus-within styles</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pseudo-panel" data-pseudo="valid">
                                        <div class="form-group">
                                            <label for="valid-css" class="form-label">Valid State CSS</label>
                                            <textarea id="valid-css" class="form-textarea pseudo-css" rows="3"
                                                placeholder="border-color: #28a745;
background-color: #f8fff9;" aria-describedby="valid-help"></textarea>
                                            <small id="valid-help" class="form-help">CSS applied when form input is
                                                valid</small>
                                            <div class="pseudo-class-toggle">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" class="pseudo-enabled" data-pseudo="valid"
                                                        aria-label="Enable valid styles">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="toggle-label">Enable :valid styles</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pseudo-panel" data-pseudo="invalid">
                                        <div class="form-group">
                                            <label for="invalid-css" class="form-label">Invalid State CSS</label>
                                            <textarea id="invalid-css" class="form-textarea pseudo-css" rows="3"
                                                placeholder="border-color: #dc3545;
background-color: #fff8f8;" aria-describedby="invalid-help"></textarea>
                                            <small id="invalid-help" class="form-help">CSS applied when form input is
                                                invalid</small>
                                            <div class="pseudo-class-toggle">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" class="pseudo-enabled" data-pseudo="invalid"
                                                        aria-label="Enable invalid styles">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="toggle-label">Enable :invalid styles</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pseudo-panel" data-pseudo="disabled">
                                        <div class="form-group">
                                            <label for="disabled-css" class="form-label">Disabled State CSS</label>
                                            <textarea id="disabled-css" class="form-textarea pseudo-css" rows="3"
                                                placeholder="opacity: 0.5;
cursor: not-allowed;
background-color: #f5f5f5;" aria-describedby="disabled-help"></textarea>
                                            <small id="disabled-help" class="form-help">CSS applied when form element is
                                                disabled</small>
                                            <div class="pseudo-class-toggle">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" class="pseudo-enabled" data-pseudo="disabled"
                                                        aria-label="Enable disabled styles">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="toggle-label">Enable :disabled styles</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pseudo-panel" data-pseudo="checked">
                                        <div class="form-group">
                                            <label for="checked-css" class="form-label">Checked State CSS</label>
                                            <textarea id="checked-css" class="form-textarea pseudo-css" rows="3"
                                                placeholder="background-color: #007acc;
border-color: #007acc;" aria-describedby="checked-help"></textarea>
                                            <small id="checked-help" class="form-help">CSS applied when checkbox or
                                                radio button is checked</small>
                                            <div class="pseudo-class-toggle">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" class="pseudo-enabled" data-pseudo="checked"
                                                        aria-label="Enable checked styles">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="toggle-label">Enable :checked styles</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" id="test-selector" class="btn btn-secondary">Test Selector</button>
                            <button type="button" id="preview-rule" class="btn btn-secondary">Preview</button>
                            <button type="button" id="eyedropper-btn" class="btn btn-secondary" title="Pick element or color">
                                <span class="btn-icon">🎨</span>
                                Eyedropper
                            </button>
                            <button type="submit" class="btn btn-primary">Save Advanced Rule</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ENHANCED: Active Rules List -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Active Rules</h2>
                    <span id="rule-count" class="rule-count">0 rules</span>
                </div>

                <!-- NEW: Search and Filter Bar -->
                <div class="search-filter-bar">
                    <div class="search-container">
                        <input type="text" id="search-input" class="search-input" placeholder="Search rules...">
                        <button id="clear-search" class="btn-icon" style="display: none;" aria-label="Clear search">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="filter-controls">
                        <select id="filter-status" class="filter-select">
                            <option value="all">All Status</option>
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                        <select id="filter-sort" class="filter-select">
                            <option value="modified-desc">Recent First</option>
                            <option value="modified-asc">Oldest First</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                        </select>
                    </div>
                </div>

                <div class="sync-info">
                    <span id="sync-status" class="sync-status">Never synced</span>
                    <button id="sync-rules" class="btn btn-secondary btn-sm">Sync</button>
                </div>

                <div id="customization-list" class="customization-list">
                    <!-- Rules will be populated here -->
                </div>

                <div id="empty-state" class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z" />
                        <path d="M2 17L12 22L22 17" />
                        <path d="M2 12L12 17L22 12" />
                    </svg>
                    <p>No customization rules yet</p>
                    <p class="text-muted">Create your first rule to get started</p>
                </div>
            </div>

            <!-- NEW: Export/Import & Screenshot Section -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Export / Import / Screenshot</h2>
                    <div class="export-import-actions">
                        <button id="export-btn" class="btn btn-secondary btn-sm">Export</button>
                        <button id="import-btn" class="btn btn-secondary btn-sm">Import</button>
                        <button id="screenshot-btn" class="btn btn-secondary btn-sm" title="Capture screenshot">
                            📷 Screenshot
                        </button>
                    </div>
                </div>

                <!-- Export Options (hidden by default) -->
                <div id="export-options" class="export-import-panel" style="display: none;">
                    <h3>Export Options</h3>
                    <div class="form-group">
                        <label class="form-label">Format</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="export-format" value="json" checked>
                                <span>JSON (Recommended)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="export-format" value="csv">
                                <span>CSV (Excel compatible)</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-metadata" checked>
                            <span>Include metadata (export date, user, version)</span>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button id="do-export" class="btn btn-primary">Download</button>
                        <button id="cancel-export" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>

                <!-- Import Options (hidden by default) -->
                <div id="import-options" class="export-import-panel" style="display: none;">
                    <h3>Import Options</h3>
                    <div class="form-group">
                        <label class="form-label">Merge Strategy</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="merge-strategy" value="merge" checked>
                                <span>Merge (Update existing, add new)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="merge-strategy" value="replace">
                                <span>Replace (Delete all, import new)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="merge-strategy" value="skip">
                                <span>Skip duplicates (Only add new)</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="validate-import" checked>
                            <span>Validate rules before importing</span>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button id="select-file" class="btn btn-primary">Select File</button>
                        <button id="cancel-import" class="btn btn-secondary">Cancel</button>
                    </div>
                    <div id="import-status" class="import-status" style="display: none;"></div>
                </div>

                <!-- Screenshot Options (hidden by default) -->
                <div id="screenshot-options" class="export-import-panel" style="display: none;">
                    <h3>Screenshot Options</h3>
                    <div class="form-group">
                        <label class="form-label">Capture Type</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="screenshot-type" value="visible" checked>
                                <span>Visible Area (Fast)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="screenshot-type" value="fullpage">
                                <span>Full Page (Complete)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="screenshot-type" value="element">
                                <span>Selected Element</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group" id="element-selector-group" style="display: none;">
                        <label class="form-label">Element Selector</label>
                        <input type="text" id="screenshot-selector" class="form-input" placeholder="e.g., .main-content, #header">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="screenshot-markup" checked>
                            <span>Enable markup tools after capture</span>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button id="do-screenshot" class="btn btn-primary">Capture</button>
                        <button id="cancel-screenshot" class="btn btn-secondary">Cancel</button>
                    </div>
                    <div id="screenshot-status" class="import-status" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ENHANCED: User view with improved features -->
    <div id="user-view" class="view">
        <div class="header">
            <h1>DOM Style Injector</h1>
            <div class="subtitle">Enterprise customizations active</div>
        </div>

        <div class="content">
            <div class="section">
                <div class="user-info-banner">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="20" height="20">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z" />
                        <path d="M2 17L12 22L22 17" />
                        <path d="M2 12L12 17L22 12" />
                    </svg>
                    <div>
                        <p class="info-title">Enterprise styles are active</p>
                        <p class="info-subtitle">Your administrator has configured custom styles for this site</p>
                    </div>
                </div>

                <!-- User Statistics -->
                <div class="user-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="user-total-rules">0</span>
                        <span class="stat-label">Total Rules</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="user-active-rules">0</span>
                        <span class="stat-label">Active</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="user-last-sync">Never</span>
                        <span class="stat-label">Last Sync</span>
                    </div>
                </div>

                <!-- Search for users (read-only) -->
                <div class="user-search-container">
                    <input type="text" id="user-search-input" class="search-input" placeholder="Search active rules...">
                </div>

                <div class="sync-info">
                    <span id="user-sync-status" class="sync-status">Checking for updates...</span>
                    <button id="user-sync-rules" class="btn btn-secondary btn-sm">Refresh</button>
                </div>

                <div id="user-customization-list" class="customization-list user-mode">
                    <!-- User rules will be populated here -->
                </div>

                <div id="user-empty-state" class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9 12L11 14L15 10" />
                        <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" />
                    </svg>
                    <p>No customizations available</p>
                    <p class="text-muted">Contact your System Administrator to request changes</p>
                </div>

                <!-- Contact Admin Section -->
                <div class="contact-admin-section">
                    <h3>Need Changes?</h3>
                    <p>Contact your System Administrator or System Customizer to:</p>
                    <ul>
                        <li>Request new style customizations</li>
                        <li>Report issues with existing styles</li>
                        <li>Suggest improvements</li>
                    </ul>
                    <button id="copy-diagnostics" class="btn btn-secondary">Copy Diagnostics</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRESERVED: Error view (unchanged from original) -->
    <div id="error-view" class="view">
        <div class="header">
            <h1>Error</h1>
            <div class="subtitle">Something went wrong</div>
        </div>

        <div class="content">
            <div class="section">
                <div class="message message-error">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M15 9L9 15" />
                        <path d="M9 9L15 15" />
                    </svg>
                    <span id="error-message">An error occurred.</span>
                </div>

                <div class="form-actions">
                    <button id="retry-auth-btn" class="btn btn-primary">Retry</button>
                    <button id="open-settings-btn" class="btn btn-secondary">Open Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRESERVED: Original script reference -->
    <script src="../scripts/search-filter.js"></script>
    <script src="../scripts/export-import.js"></script>
    <script src="../scripts/screenshot-manager.js"></script>
    <script src="../scripts/eyedropper-manager.js"></script>
    <script src="popup.js"></script>
    <script src="../scripts/dev-mode-indicator.js"></script>
</body>

</html>